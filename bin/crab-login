#!/usr/bin/env ruby
# vim: set ft=ruby :
require 'crab'

class Crab::Login

  class << self

    include Crab::Utilities

    def run(args=ARGV)
      opts = Trollop::options(args) do
        banner <<-BANNER
Usage: crab login [options*]

Log into Rally. Your credentials will be written to ~/.crab/credentials unless --project is specified.
        BANNER

        opt :username, "Username", :type => String, :short => "-u"
        opt :password, "Password", :type => String, :short => "-p"
        opt :project, "Store credentials into current folder", :short => "-P", :default => false
      end

      username = opts[:username_given] ? opts[:username] : ask("Username: ")
      password = opts[:password_given] ? opts[:password] : ask("Password: ") {|q| q.echo = false }

      # TODO: clean this up
      if opts[:project_given]
        FileUtils.mkdir_p File.expand_path('./.crab')
        credentials_file = File.expand_path("./.crab/credentials")
      else
        credentials_file = self.credentials_file
      end

      File.open(credentials_file, 'w') do |file|
        file.puts username
        file.puts password
      end

      puts "Credentials stored for #{username}"
    end
  end
end

Crab::Login.run
