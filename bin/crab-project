#!/usr/bin/env ruby
# vim: set ft=ruby :
require 'crab'

class Crab::ProjectMain

  class << self

    include Crab::Utilities

    def run(args=ARGV)
      opts = Trollop::options(args) do
        banner <<-BANNER
crab project: show or persistently select project to work with in Rally

Usage: crab project [name] [options*]
        BANNER
        opt :dry, "Dry-run (don't change anything)", :short => "-D", :default => false
      end

      if current_project_name.present?
        puts current_project_name
        exit 0

      elsif args.reject {|arg| arg.blank? }.empty?
        puts "No project currently selected."
        exit 1
      end

      name = args.join(" ").strip

      Crab::Rally.new(opts[:dry]) do |rally|
        project = rally.find_project name
        Trollop::die "#{name.inspect} is not a valid project" if project.nil?

        FileUtils.mkdir_p ".crab", opts[:dry] ? { :noop => true, :verbose => true } : {}
        file = ".crab/project"
        output = project.name

        if opts[:dry]
          puts "Would write to #{file}:\n\n#{output}"
        else
          File.open(file, "w") do |file|
            file.puts project.name
          end
        end
      end
    end
  end
end

Crab::ProjectMain.run
